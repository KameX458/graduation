<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>那覇高校 野球部</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        
        /* UI全体のオーバーレイ */
        #ui-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; pointer-events: none;
            color: white; font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }

        /* ヘッダータイトル */
        .header-title {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid #fff;
            letter-spacing: 0.1em;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        /* ステータスメッセージ */
        .status-msg {
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border-radius: 8px; margin-top: 15px; font-size: 14px;
        }

        /* 読み取り枠（太枠） */
        #scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 6px solid #fff; /* 太枠 */
            border-radius: 24px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.4); /* 枠以外を暗くする */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }

        #scan-guide::before {
            content: "SCANNING...";
            font-size: 12px;
            letter-spacing: 0.2em;
            color: #fff;
            position: absolute;
            bottom: -35px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* ログ表示 */
        #debug-log {
            position: fixed; 
            bottom: 15px; 
            left: 15px; 
            font-size: 14px; 
            padding: 8px 12px; 
            border-radius: 6px;
            color: #0f0; 
            background: rgba(0,0,0,0.6); 
            pointer-events: none; 
            z-index: 20;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="debug-log">ログ：初期化中...</div>

    <div id="ui-overlay">
        <div class="header-title">那覇高校 野球部</div>
        <div id="status-text" class="status-msg">システムを起動中...</div>
        
        <!-- 読み取り枠ガイド -->
        <div id="scan-guide"></div>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: true; uiLoading: no; uiScanning: no; filterMinCF: 0.00001; filterBeta: 0.001; missTolerance: 5;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <img id="img01" src="view_01.jpg">
            <img id="img02" src="view_02.jpg">
            <img id="img03" src="view_03.jpg">
            <img id="img04" src="view_04.jpg">
            <img id="img05" src="view_05.jpg">

            <img id="img11" src="view_11.jpg">
            <img id="img12" src="view_12.jpg">
            <img id="img13" src="view_13.jpg">
            <img id="img14" src="view_14.jpg">
            <img id="img15" src="view_15.jpg">
            <img id="img16" src="view_16.jpg">
            <img id="img17" src="view_17.jpg">
            <img id="img18" src="view_18.jpg">
            <img id="img19" src="view_19.jpg">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- ターゲット 1 (Index 0) - width=3 -->
        <a-entity mindar-image-target="targetIndex: 0" class="ar-target">
            <a-image src="#img01" class="slideshow-item" position="0 0 0.01" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img02" class="slideshow-item" position="0 0 0.02" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img03" class="slideshow-item" position="0 0 0.03" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img04" class="slideshow-item" position="0 0 0.04" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img05" class="slideshow-item" position="0 0 0.05" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
        </a-entity>

        <!-- ターゲット 2 (Index 1) - width=3 -->
        <a-entity mindar-image-target="targetIndex: 1" class="ar-target">
            <a-image src="#img11" class="slideshow-item" position="0 0 0.01" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img12" class="slideshow-item" position="0 0 0.02" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img13" class="slideshow-item" position="0 0 0.03" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img14" class="slideshow-item" position="0 0 0.04" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img15" class="slideshow-item" position="0 0 0.05" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img16" class="slideshow-item" position="0 0 0.06" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img17" class="slideshow-item" position="0 0 0.07" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img18" class="slideshow-item" position="0 0 0.08" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img19" class="slideshow-item" position="0 0 0.09" width="3" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
        </a-entity>

    </a-scene>

    <script>
        const statusText = document.getElementById('status-text');
        const debugLog = document.getElementById('debug-log');
        const scanGuide = document.getElementById('scan-guide');
        const sceneEl = document.querySelector('a-scene');
        
        const FADE_DUR = 1200;
        const DISPLAY_DUR = 3500;

        function log(msg) {
            console.log(msg);
            debugLog.innerText = msg;
        }

        class TargetSlideshow {
            constructor(targetEl) {
                this.targetEl = targetEl;
                this.slides = targetEl.querySelectorAll('.slideshow-item');
                this.currentIndex = 0;
                this.slideInterval = null;
                this.init();
            }

            init() {
                this.slides.forEach((imgEntity) => {
                    const src = imgEntity.getAttribute('src');
                    const imgAsset = document.querySelector(src);
                    
                    const setSize = () => {
                        const currentWidth = parseFloat(imgEntity.getAttribute('width')) || 1.0;
                        const ratio = imgAsset.naturalHeight / imgAsset.naturalWidth;
                        imgEntity.setAttribute('height', currentWidth * ratio);
                    };

                    if (imgAsset.complete) setSize();
                    else imgAsset.addEventListener('load', setSize);
                });

                this.targetEl.addEventListener("targetFound", () => {
                    log("ログ：ターゲットを認識しました");
                    statusText.innerText = "コンテンツ再生中...";
                    scanGuide.style.opacity = "0";
                    this.start();
                });

                this.targetEl.addEventListener("targetLost", () => {
                    log("ログ：ターゲットを認識できません");
                    statusText.innerText = "〜 卒部式プログラム をスキャンしてください 〜";
                    scanGuide.style.opacity = "1";
                    this.stop();
                });
            }

            fade(element, from, to) {
                element.removeAttribute('animation');
                element.setAttribute('animation', {
                    property: 'material.opacity',
                    from: from,
                    to: to,
                    dur: FADE_DUR,
                    easing: 'easeInOutQuad'
                });
            }

            start() {
                if (this.slideInterval) return;
                this.fade(this.slides[this.currentIndex], 0, 1);
                this.slideInterval = setInterval(() => {
                    const prevSlide = this.slides[this.currentIndex];
                    this.fade(prevSlide, 1, 0);
                    this.currentIndex = (this.currentIndex + 1) % this.slides.length;
                    const nextSlide = this.slides[this.currentIndex];
                    this.fade(nextSlide, 0, 1);
                }, DISPLAY_DUR);
            }

            stop() {
                clearInterval(this.slideInterval);
                this.slideInterval = null;
                this.slides.forEach(s => {
                    s.removeAttribute('animation');
                    s.setAttribute('opacity', '0');
                });
                this.currentIndex = 0;
            }
        }

        sceneEl.addEventListener("arReady", () => {
            log("ログ：ARの準備が完了しました");
            statusText.innerText = "〜 卒部式プログラム をスキャンしてください 〜";
            document.querySelectorAll('.ar-target').forEach(el => new TargetSlideshow(el));
        });

        sceneEl.addEventListener("arError", () => {
            log("ログ：ARエラーが発生しました");
            statusText.innerHTML = "<span style='color:red'>カメラエラー</span>";
        });
    </script>
</body>
</html>
