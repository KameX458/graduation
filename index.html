<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Slideshow - Vertical Scan</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        :root {
            --primary-color: #00f2ff;
        }
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Helvetica Neue', Arial, sans-serif; }
        
        /* „É°„Ç§„É≥UI„É¨„Ç§„É§„Éº */
        #ui-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; pointer-events: none; color: white;
        }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éä„Éº */
        .status-header {
            width: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            padding: 20px 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #status-text { font-size: 18px; font-weight: bold; letter-spacing: 0.05em; }

        /* „Çπ„Ç≠„É£„É≥Áî®„Ç¨„Ç§„ÉâÊû†ÔºàÁ∏¶Èï∑„Å´‰øÆÊ≠£Ôºö240x360Ôºâ */
        #scan-guide {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 240px; height: 360px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .corner {
            position: absolute; width: 30px; height: 30px;
            border: 4px solid var(--primary-color);
        }
        .top-left { top: -5px; left: -5px; border-right: 0; border-bottom: 0; border-top-left-radius: 15px; }
        .top-right { top: -5px; right: -5px; border-left: 0; border-bottom: 0; border-top-right-radius: 15px; }
        .bottom-left { bottom: -5px; left: -5px; border-right: 0; border-top: 0; border-bottom-left-radius: 15px; }
        .bottom-right { bottom: -5px; right: -5px; border-left: 0; border-top: 0; border-bottom-right-radius: 15px; }

        .scan-line {
            position: absolute; width: 100%; height: 2px;
            background: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
            top: 0; left: 0;
            animation: scanMove 3s infinite ease-in-out;
        }
        @keyframes scanMove {
            0%, 100% { top: 5%; opacity: 0.2; }
            50% { top: 95%; opacity: 1; }
        }

        .hint-box {
            position: absolute; bottom: 80px;
            background: rgba(0,0,0,0.7); padding: 12px 24px;
            border-radius: 30px; font-size: 14px; color: #ddd;
            display: flex; align-items: center; gap: 8px;
        }

        #debug-log {
            position: fixed; bottom: 10px; left: 10px; font-size: 9px;
            color: rgba(255,255,255,0.3); z-index: 20;
        }

        .hidden { opacity: 0 !important; visibility: hidden; }
    </style>
</head>
<body>
    <div id="debug-log">System Initializing...</div>

    <div id="ui-overlay">
        <div class="status-header">
            <div id="status-text">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>

        <div id="scan-guide" class="hidden">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
            <div class="scan-line"></div>
        </div>

        <div id="hint-text" class="hint-box hidden">
            <span>üí° Á∏¶Èï∑„Å´Âèé„Åæ„Çã„Çà„ÅÜ„Åã„Åñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
        </div>
    </div>

    <a-scene 
        id="ar-scene"
        mindar-image="autoStart: true; uiLoading: no; uiScanning: no; filterMinCF: 0.0001; filterBeta: 0.01; missTolerance: 5;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <!-- Target 1 Images -->
            <img id="img01" src="view_01.jpg">
            <img id="img02" src="view_02.jpg">
            <img id="img03" src="view_03.jpg">
            <img id="img04" src="view_04.jpg">
            <img id="img05" src="view_05.jpg">

            <!-- Target 2 Images -->
            <img id="img11" src="view_11.jpg">
            <img id="img12" src="view_12.jpg">
            <img id="img13" src="view_13.jpg">
            <img id="img14" src="view_14.jpg">
            <img id="img15" src="view_15.jpg">
            <img id="img16" src="view_16.jpg">
            <img id="img17" src="view_17.jpg">
            <img id="img18" src="view_18.jpg">
            <img id="img19" src="view_19.jpg">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- ÁîªÂÉè„Çµ„Ç§„Ç∫„ÇíÂ§ß„Åç„ÅèË®≠ÂÆö (width: 1.8) -->
        <a-entity mindar-image-target="targetIndex: 0" class="ar-target">
            <a-image src="#img01" class="slideshow-item" position="0 0 0.01" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img02" class="slideshow-item" position="0 0 0.02" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img03" class="slideshow-item" position="0 0 0.03" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img04" class="slideshow-item" position="0 0 0.04" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img05" class="slideshow-item" position="0 0 0.05" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1" class="ar-target">
            <a-image src="#img11" class="slideshow-item" position="0 0 0.01" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img12" class="slideshow-item" position="0 0 0.02" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img13" class="slideshow-item" position="0 0 0.03" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img14" class="slideshow-item" position="0 0 0.04" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img15" class="slideshow-item" position="0 0 0.05" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img16" class="slideshow-item" position="0 0 0.06" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img17" class="slideshow-item" position="0 0 0.07" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img18" class="slideshow-item" position="0 0 0.08" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
            <a-image src="#img19" class="slideshow-item" position="0 0 0.09" width="1.8" transparent="true" opacity="0" material="shader: flat; depthTest: false"></a-image>
        </a-entity>

    </a-scene>

    <script>
        const statusText = document.getElementById('status-text');
        const debugLog = document.getElementById('debug-log');
        const scanGuide = document.getElementById('scan-guide');
        const hintBox = document.getElementById('hint-text');
        const sceneEl = document.querySelector('a-scene');
        
        const FADE_DUR = 1200;
        const DISPLAY_DUR = 4000;
        const BASE_WIDTH = 1.8; // ÁîªÂÉè„ÅÆË°®Á§∫ÂπÖ

        function log(msg) {
            console.log(msg);
            debugLog.innerText = "Log: " + msg;
        }

        function initTargetSrc() {
            const targetPath = new URL('targets.mind', window.location.href).href;
            log("Target path: " + targetPath);
            sceneEl.setAttribute('mindar-image', { imageTargetSrc: targetPath });
        }

        class TargetSlideshow {
            constructor(targetEl) {
                this.targetEl = targetEl;
                this.slides = targetEl.querySelectorAll('.slideshow-item');
                this.currentIndex = 0;
                this.slideInterval = null;
                this.init();
            }

            init() {
                this.slides.forEach((imgEntity) => {
                    const src = imgEntity.getAttribute('src');
                    const imgAsset = document.querySelector(src);
                    const setSize = () => {
                        const ratio = imgAsset.naturalHeight / imgAsset.naturalWidth;
                        imgEntity.setAttribute('height', BASE_WIDTH * ratio);
                    };
                    if (imgAsset.complete) setSize();
                    else imgAsset.addEventListener('load', setSize);
                });

                this.targetEl.addEventListener("targetFound", () => {
                    log(`Target Detected`);
                    this.toggleUI(false);
                    this.start();
                });

                this.targetEl.addEventListener("targetLost", () => {
                    log("Target Lost");
                    this.toggleUI(true);
                    this.stop();
                });
            }

            toggleUI(show) {
                if (show) {
                    statusText.innerText = "„Éû„Éº„Ç´„Éº„Çí„Çπ„Ç≠„É£„É≥‰∏≠...";
                    scanGuide.classList.remove('hidden');
                    hintBox.classList.remove('hidden');
                } else {
                    statusText.innerText = "„Çπ„Ç≠„É£„É≥ÂÆå‰∫ÜÔºÅË°®Á§∫‰∏≠...";
                    scanGuide.classList.add('hidden');
                    hintBox.classList.add('hidden');
                }
            }

            start() {
                if (this.slideInterval) return;
                this.slides[this.currentIndex].setAttribute('animation', `property: components.material.material.opacity; from: 0; to: 1; dur: ${FADE_DUR}; easing: easeInOutQuad`);
                
                this.slideInterval = setInterval(() => {
                    const prevSlide = this.slides[this.currentIndex];
                    prevSlide.setAttribute('animation', `property: components.material.material.opacity; from: 1; to: 0; dur: ${FADE_DUR}; easing: easeInOutQuad`);
                    this.currentIndex = (this.currentIndex + 1) % this.slides.length;
                    const nextSlide = this.slides[this.currentIndex];
                    nextSlide.setAttribute('animation', `property: components.material.material.opacity; from: 0; to: 1; dur: ${FADE_DUR}; easing: easeInOutQuad`);
                }, DISPLAY_DUR);
            }

            stop() {
                clearInterval(this.slideInterval);
                this.slideInterval = null;
                this.slides.forEach(s => {
                    s.removeAttribute('animation');
                    s.setAttribute('opacity', '0');
                });
                this.currentIndex = 0;
            }
        }

        initTargetSrc();

        sceneEl.addEventListener("arReady", () => {
            log("AR Ready");
            statusText.innerText = "„Éû„Éº„Ç´„Éº„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            scanGuide.classList.remove('hidden');
            hintBox.classList.remove('hidden');
            
            const targetEntities = document.querySelectorAll('.ar-target');
            targetEntities.forEach(el => new TargetSlideshow(el));
        });

        sceneEl.addEventListener("arError", (event) => {
            log("AR Error");
            statusText.innerHTML = "<span style='color:#ff4444'>Ëµ∑Âãï„Ç®„É©„Éº</span>";
        });
    </script>
</body>
</html>
